{% extends 'layout/a_staff/employee/base_employee.html.twig' %}

{% block title %}Dashboard Employé{% endblock %}

{% block body %}

<section>
    <h1 class="text-center text-white text-uppercase mt-2 fw-bold">dashboard employé</h1>

    <div class="employee-dashboard">
        <div class="covoit-table-wrapper">

            <h2 class="covoit-title mt-2">
                Covoiturages du {{ "now"|date("d/m/Y") }}
            </h2>

            <table class="covoit-table">
                <thead>
                    <tr>
                        <th>N°</th>
                        <th>Date</th>
                        <th>Chauffeur</th>
                        <th>Statut</th>
                        <th>Note min</th>
                        <th>Réclamation</th>
                        <th>Nb passagers</th>
                        <th>COM</th>
                    </tr>
                </thead>

                <tbody>
                    {% set totalCovoits = 0 %}
                    {% set totalCredits = 0 %}

                    {% for covoit in covoiturages %}
                        {% set totalCovoits = totalCovoits + 1 %}

                        {# ---------------------------------------
                           ID style photo avec secondes : YYYYMMDDHHmmss
                           Exemple : 20260128172543
                           --------------------------------------- #}
                        {% set covoitCode = covoit.date|date('YmdHis') %}

                        {# ---------------------------------------
                           Simulation du nombre de passagers (1 à 3)
                           À remplacer plus tard par :
                           covoit.passengers|length
                           --------------------------------------- #}
                        {% set nbPassagers = (covoit.id % 3) + 1 %}

                        {# ---------------------------------------
                           Simulation STATUT
                           Plus tard : covoit.status ou endedAt
                           --------------------------------------- #}
                        {% set statut = (covoit.id % 2 == 0) ? 'en_cours' : 'termine' %}

                        {# ---------------------------------------
                           NOTE MIN :
                           - si terminé => note (1 à 5)
                           - si en cours => vide
                           --------------------------------------- #}
                        {% if statut == 'termine' %}
                            {% set noteMin = (covoit.id % 5) + 1 %}
                        {% else %}
                            {% set noteMin = null %}
                        {% endif %}

                        {# réclamation si terminé et note min < 3 #}
                        {% set isReclamation = (statut == 'termine') and (noteMin is not null) and (noteMin < 3) %}

                        {# commission = 2 crédits par passager #}
                        {% set com = nbPassagers * 2 %}
                        {% set totalCredits = totalCredits + com %}

                        <tr
                            class="{{ isReclamation ? 'reclamation' : '' }}"
                            onclick="window.location='{{ path('employee_covoiturage_show', { id: covoit.id }) }}'"
                        >
                            <td>{{ covoitCode }}</td>
                            <td>{{ covoit.date|date('d/m/Y') }}</td>
                            <td>{{ covoit.driver }}</td>

                            <td class="text-center">
                                {% if statut == 'en_cours' %}
                                    <span class="badge badge-en-cours">En cours</span>
                                {% else %}
                                    <span class="badge badge-termine">Terminé</span>
                                {% endif %}
                            </td>

                            <td class="text-center">
                                {% if statut == 'termine' %}
                                    {{ noteMin }}/5
                                {% else %}
                                    —
                                {% endif %}
                            </td>

                            <td class="text-center">
                                {% if statut == 'termine' %}
                                    <input
                                        type="checkbox"
                                        disabled
                                        {% if isReclamation %}checked{% endif %}
                                    >
                                {% else %}
                                    —
                                {% endif %}
                            </td>

                            <td class="text-center">{{ nbPassagers }}</td>

                            <td class="text-center">{{ com }}</td>
                        </tr>

                    {% else %}
                        <tr class="empty">
                            <td colspan="8">Aucun covoiturage aujourd’hui</td>
                        </tr>
                    {% endfor %}
                </tbody>

                {% if totalCovoits > 0 %}
                <tfoot>
                    <tr class="total-row">
                        <td colspan="8">
                            TOTAL — {{ totalCovoits }} covoiturage{{ totalCovoits > 1 ? 's' : '' }}
                            | Commission plateforme : {{ totalCredits }} crédits
                        </td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>

        </div>
    </div>
</section>

{% endblock %}
